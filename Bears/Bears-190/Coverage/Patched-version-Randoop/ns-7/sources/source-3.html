


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PostgresStorage</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">io.cassandrareaper.storage</a>
</div>

<h1>Coverage Summary for Class: PostgresStorage (io.cassandrareaper.storage)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PostgresStorage</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/236)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package io.cassandrareaper.storage;
&nbsp;
&nbsp;import io.cassandrareaper.core.Cluster;
&nbsp;import io.cassandrareaper.core.RepairRun;
&nbsp;import io.cassandrareaper.core.RepairSchedule;
&nbsp;import io.cassandrareaper.core.RepairSegment;
&nbsp;import io.cassandrareaper.core.RepairUnit;
&nbsp;import io.cassandrareaper.resources.view.RepairRunStatus;
&nbsp;import io.cassandrareaper.resources.view.RepairScheduleStatus;
&nbsp;import io.cassandrareaper.service.RepairParameters;
&nbsp;import io.cassandrareaper.service.RingRange;
&nbsp;import io.cassandrareaper.storage.postgresql.BigIntegerArgumentFactory;
&nbsp;import io.cassandrareaper.storage.postgresql.IStoragePostgreSql;
&nbsp;import io.cassandrareaper.storage.postgresql.LongCollectionSqlTypeArgumentFactory;
&nbsp;import io.cassandrareaper.storage.postgresql.PostgresArrayArgumentFactory;
&nbsp;import io.cassandrareaper.storage.postgresql.RepairParallelismArgumentFactory;
&nbsp;import io.cassandrareaper.storage.postgresql.RunStateArgumentFactory;
&nbsp;import io.cassandrareaper.storage.postgresql.ScheduleStateArgumentFactory;
&nbsp;import io.cassandrareaper.storage.postgresql.StateArgumentFactory;
&nbsp;import io.cassandrareaper.storage.postgresql.UuidArgumentFactory;
&nbsp;import io.cassandrareaper.storage.postgresql.UuidUtil;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collection;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;import com.google.common.base.Optional;
&nbsp;import com.google.common.collect.Lists;
&nbsp;import org.skife.jdbi.v2.DBI;
&nbsp;import org.skife.jdbi.v2.Handle;
&nbsp;import org.skife.jdbi.v2.exceptions.DBIException;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;/**
&nbsp; * Implements the StorageAPI using PostgreSQL database.
&nbsp; */
&nbsp;public final class PostgresStorage implements IStorage {
&nbsp;
<b class="nc">&nbsp;  private static final Logger LOG = LoggerFactory.getLogger(PostgresStorage.class);</b>
&nbsp;
&nbsp;  private final DBI jdbi;
&nbsp;
<b class="nc">&nbsp;  public PostgresStorage(DBI jdbi) {</b>
<b class="nc">&nbsp;    this.jdbi = jdbi;</b>
&nbsp;  }
&nbsp;
&nbsp;  private static IStoragePostgreSql getPostgresStorage(Handle handle) {
<b class="nc">&nbsp;    handle.registerArgumentFactory(new LongCollectionSqlTypeArgumentFactory());</b>
<b class="nc">&nbsp;    handle.registerArgumentFactory(new PostgresArrayArgumentFactory());</b>
<b class="nc">&nbsp;    handle.registerArgumentFactory(new RunStateArgumentFactory());</b>
<b class="nc">&nbsp;    handle.registerArgumentFactory(new RepairParallelismArgumentFactory());</b>
<b class="nc">&nbsp;    handle.registerArgumentFactory(new StateArgumentFactory());</b>
<b class="nc">&nbsp;    handle.registerArgumentFactory(new BigIntegerArgumentFactory());</b>
<b class="nc">&nbsp;    handle.registerArgumentFactory(new ScheduleStateArgumentFactory());</b>
<b class="nc">&nbsp;    handle.registerArgumentFactory(new UuidArgumentFactory());</b>
<b class="nc">&nbsp;    return handle.attach(IStoragePostgreSql.class);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;Cluster&gt; getCluster(String clusterName) {
&nbsp;    Cluster result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getCluster(clusterName);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;Cluster&gt; deleteCluster(String clusterName) {
<b class="nc">&nbsp;    Cluster result = null;</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      IStoragePostgreSql pg = getPostgresStorage(h);</b>
<b class="nc">&nbsp;      Cluster clusterToDel = pg.getCluster(clusterName);</b>
<b class="nc">&nbsp;      if (clusterToDel != null) {</b>
<b class="nc">&nbsp;        int rowsDeleted = pg.deleteCluster(clusterName);</b>
<b class="nc">&nbsp;        if (rowsDeleted &gt; 0) {</b>
<b class="nc">&nbsp;          result = clusterToDel;</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public boolean isStorageConnected() {
<b class="nc">&nbsp;    String currentDate = null;</b>
<b class="nc">&nbsp;    if (null != jdbi) {</b>
<b class="nc">&nbsp;      try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;        currentDate = getPostgresStorage(h).getCurrentDate();</b>
<b class="nc">&nbsp;      }</b>
&nbsp;    }
<b class="nc">&nbsp;    return null != currentDate &amp;&amp; !currentDate.trim().isEmpty();</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;Cluster&gt; getClusters() {
&nbsp;    Collection&lt;Cluster&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getClusters();</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result != null ? result : Lists.&lt;Cluster&gt;newArrayList();</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public boolean addCluster(Cluster newCluster) {
<b class="nc">&nbsp;    Cluster result = null;</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      int rowsAdded = getPostgresStorage(h).insertCluster(newCluster);</b>
<b class="nc">&nbsp;      if (rowsAdded &lt; 1) {</b>
<b class="nc">&nbsp;        LOG.warn(&quot;failed inserting cluster with name: {}&quot;, newCluster.getName());</b>
&nbsp;      } else {
<b class="nc">&nbsp;        result = newCluster; // no created id, as cluster name used for primary key</b>
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result != null;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public boolean updateCluster(Cluster cluster) {
<b class="nc">&nbsp;    boolean result = false;</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      int rowsAdded = getPostgresStorage(h).updateCluster(cluster);</b>
<b class="nc">&nbsp;      if (rowsAdded &lt; 1) {</b>
<b class="nc">&nbsp;        LOG.warn(&quot;failed updating cluster with name: {}&quot;, cluster.getName());</b>
&nbsp;      } else {
<b class="nc">&nbsp;        result = true;</b>
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;RepairRun&gt; getRepairRun(UUID id) {
&nbsp;    RepairRun result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairRun(UuidUtil.toSequenceId(id));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairRun&gt; getRepairRunsForCluster(String clusterName) {
&nbsp;    Collection&lt;RepairRun&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairRunsForCluster(clusterName);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result == null ? Lists.&lt;RepairRun&gt;newArrayList() : result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairRun&gt; getRepairRunsForUnit(UUID repairUnitId) {
&nbsp;    Collection&lt;RepairRun&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairRunsForUnit(UuidUtil.toSequenceId(repairUnitId));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result == null ? Lists.&lt;RepairRun&gt;newArrayList() : result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairRun&gt; getRepairRunsWithState(RepairRun.RunState runState) {
&nbsp;    Collection&lt;RepairRun&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairRunsWithState(runState);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result == null ? Lists.&lt;RepairRun&gt;newArrayList() : result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;RepairRun&gt; deleteRepairRun(UUID id) {
<b class="nc">&nbsp;    RepairRun result = null;</b>
<b class="nc">&nbsp;    Handle handle = null;</b>
&nbsp;    try {
<b class="nc">&nbsp;      handle = jdbi.open();</b>
<b class="nc">&nbsp;      handle.begin();</b>
<b class="nc">&nbsp;      IStoragePostgreSql pg = getPostgresStorage(handle);</b>
<b class="nc">&nbsp;      RepairRun runToDelete = pg.getRepairRun(UuidUtil.toSequenceId(id));</b>
<b class="nc">&nbsp;      if (runToDelete != null) {</b>
<b class="nc">&nbsp;        int segmentsRunning</b>
<b class="nc">&nbsp;            = pg.getSegmentAmountForRepairRunWithState(UuidUtil.toSequenceId(id), RepairSegment.State.RUNNING);</b>
<b class="nc">&nbsp;        if (segmentsRunning == 0) {</b>
<b class="nc">&nbsp;          pg.deleteRepairSegmentsForRun(UuidUtil.toSequenceId(runToDelete.getId()));</b>
<b class="nc">&nbsp;          pg.deleteRepairRun(UuidUtil.toSequenceId(id));</b>
<b class="nc">&nbsp;          result = runToDelete.with().runState(RepairRun.RunState.DELETED).build(id);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          LOG.warn(&quot;not deleting RepairRun \&quot;{}\&quot; as it has segments running: {}&quot;, id, segmentsRunning);</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      handle.commit();</b>
<b class="nc">&nbsp;    } catch (DBIException ex) {</b>
<b class="nc">&nbsp;      LOG.warn(&quot;DELETE failed&quot;, ex);</b>
<b class="nc">&nbsp;      ex.printStackTrace();</b>
<b class="nc">&nbsp;      if (handle != null) {</b>
<b class="nc">&nbsp;        handle.rollback();</b>
&nbsp;      }
&nbsp;    } finally {
<b class="nc">&nbsp;      if (handle != null) {</b>
<b class="nc">&nbsp;        handle.close();</b>
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    if (result != null) {</b>
<b class="nc">&nbsp;      tryDeletingRepairUnit(result.getRepairUnitId());</b>
&nbsp;    }
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void tryDeletingRepairUnit(UUID id) {
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      IStoragePostgreSql pg = getPostgresStorage(h);</b>
<b class="nc">&nbsp;      pg.deleteRepairUnit(UuidUtil.toSequenceId(id));</b>
<b class="nc">&nbsp;    } catch (DBIException ex) {</b>
<b class="nc">&nbsp;      LOG.info(&quot;cannot delete RepairUnit with id &quot; + id);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public RepairRun addRepairRun(RepairRun.Builder newRepairRun, Collection&lt;RepairSegment.Builder&gt; newSegments) {
&nbsp;    RepairRun result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      long insertedId = getPostgresStorage(h).insertRepairRun(newRepairRun.build(null));</b>
<b class="nc">&nbsp;      result = newRepairRun.build(UuidUtil.fromSequenceId(insertedId));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    addRepairSegments(newSegments, result.getId());</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public boolean updateRepairRun(RepairRun repairRun) {
<b class="nc">&nbsp;    boolean result = false;</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      int rowsAdded = getPostgresStorage(h).updateRepairRun(repairRun);</b>
<b class="nc">&nbsp;      if (rowsAdded &lt; 1) {</b>
<b class="nc">&nbsp;        LOG.warn(&quot;failed updating repair run with id: {}&quot;, repairRun.getId());</b>
&nbsp;      } else {
<b class="nc">&nbsp;        result = true;</b>
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public RepairUnit addRepairUnit(RepairUnit.Builder newRepairUnit) {
&nbsp;    long insertedId;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      insertedId = getPostgresStorage(h).insertRepairUnit(newRepairUnit.build(null));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return newRepairUnit.build(UuidUtil.fromSequenceId(insertedId));</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;RepairUnit&gt; getRepairUnit(UUID id) {
&nbsp;    RepairUnit result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairUnit(UuidUtil.toSequenceId(id));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;RepairUnit&gt; getRepairUnit(
&nbsp;      String clusterName,
&nbsp;      String keyspaceName,
&nbsp;      Set&lt;String&gt; columnFamilies,
&nbsp;      Set&lt;String&gt; nodes,
&nbsp;      Set&lt;String&gt; datacenters,
&nbsp;      Set&lt;String&gt; blacklistedTables) {
&nbsp;    RepairUnit result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      IStoragePostgreSql storage = getPostgresStorage(h);</b>
<b class="nc">&nbsp;      result =</b>
<b class="nc">&nbsp;          storage.getRepairUnitByClusterAndTables(</b>
&nbsp;              clusterName, keyspaceName, columnFamilies, nodes, datacenters, blacklistedTables);
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void addRepairSegments(Collection&lt;RepairSegment.Builder&gt; newSegments, UUID runId) {
<b class="nc">&nbsp;    List&lt;RepairSegment&gt; insertableSegments = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    for (RepairSegment.Builder segment : newSegments) {</b>
<b class="nc">&nbsp;      insertableSegments.add(segment.withRunId(runId).build(null));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      getPostgresStorage(h).insertRepairSegments(insertableSegments.iterator());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public boolean updateRepairSegment(RepairSegment repairSegment) {
<b class="nc">&nbsp;    boolean result = false;</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      int rowsAdded = getPostgresStorage(h).updateRepairSegment(repairSegment);</b>
<b class="nc">&nbsp;      if (rowsAdded &lt; 1) {</b>
<b class="nc">&nbsp;        LOG.warn(&quot;failed updating repair segment with id: {}&quot;, repairSegment.getId());</b>
&nbsp;      } else {
<b class="nc">&nbsp;        result = true;</b>
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;RepairSegment&gt; getRepairSegment(UUID runId, UUID segmentId) {
&nbsp;    RepairSegment result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairSegment(UuidUtil.toSequenceId(segmentId));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairSegment&gt; getRepairSegmentsForRun(UUID runId) {
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      return getPostgresStorage(h).getRepairSegmentsForRun(UuidUtil.toSequenceId(runId));</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;
&nbsp;  private Optional&lt;RepairSegment&gt; getNextFreeSegment(UUID runId) {
&nbsp;    RepairSegment result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getNextFreeRepairSegment(UuidUtil.toSequenceId(runId));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;RepairSegment&gt; getNextFreeSegmentInRange(UUID runId, Optional&lt;RingRange&gt; range) {
<b class="nc">&nbsp;    if (range.isPresent()) {</b>
&nbsp;      RepairSegment result;
<b class="nc">&nbsp;      try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;        IStoragePostgreSql storage = getPostgresStorage(h);</b>
<b class="nc">&nbsp;        if (!range.get().isWrapping()) {</b>
<b class="nc">&nbsp;          result = storage.getNextFreeRepairSegmentInNonWrappingRange(</b>
<b class="nc">&nbsp;              UuidUtil.toSequenceId(runId), range.get().getStart(), range.get().getEnd());</b>
&nbsp;        } else {
<b class="nc">&nbsp;          result = storage.getNextFreeRepairSegmentInWrappingRange(</b>
<b class="nc">&nbsp;              UuidUtil.toSequenceId(runId), range.get().getStart(), range.get().getEnd());</b>
&nbsp;        }
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      return Optional.fromNullable(result);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      return getNextFreeSegment(runId);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairSegment&gt; getSegmentsWithState(UUID runId, RepairSegment.State segmentState) {
&nbsp;    Collection&lt;RepairSegment&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairSegmentsForRunWithState(UuidUtil.toSequenceId(runId), segmentState);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairParameters&gt; getOngoingRepairsInCluster(String clusterName) {
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      return getPostgresStorage(h).getRunningRepairsForCluster(clusterName);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;UUID&gt; getRepairRunIdsForCluster(String clusterName) {
<b class="nc">&nbsp;    Collection&lt;UUID&gt; result = Lists.newArrayList();</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      for (Long l : getPostgresStorage(h).getRepairRunIdsForCluster(clusterName)) {</b>
<b class="nc">&nbsp;        result.add(UuidUtil.fromSequenceId(l));</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public int getSegmentAmountForRepairRun(UUID runId) {
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      return getPostgresStorage(h).getSegmentAmountForRepairRun(UuidUtil.toSequenceId(runId));</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public int getSegmentAmountForRepairRunWithState(UUID runId, RepairSegment.State state) {
&nbsp;    int result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getSegmentAmountForRepairRunWithState(UuidUtil.toSequenceId(runId), state);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public RepairSchedule addRepairSchedule(RepairSchedule.Builder repairSchedule) {
&nbsp;    long insertedId;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      insertedId = getPostgresStorage(h).insertRepairSchedule(repairSchedule.build(null));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return repairSchedule.build(UuidUtil.fromSequenceId(insertedId));</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;RepairSchedule&gt; getRepairSchedule(UUID repairScheduleId) {
&nbsp;    RepairSchedule result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairSchedule(UuidUtil.toSequenceId(repairScheduleId));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairSchedule&gt; getRepairSchedulesForCluster(String clusterName) {
&nbsp;    Collection&lt;RepairSchedule&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairSchedulesForCluster(clusterName);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairSchedule&gt; getRepairSchedulesForKeyspace(String keyspaceName) {
&nbsp;    Collection&lt;RepairSchedule&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairSchedulesForKeyspace(keyspaceName);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairSchedule&gt; getRepairSchedulesForClusterAndKeyspace(String clusterName, String keyspaceName) {
&nbsp;    Collection&lt;RepairSchedule&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getRepairSchedulesForClusterAndKeySpace(clusterName, keyspaceName);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairSchedule&gt; getAllRepairSchedules() {
&nbsp;    Collection&lt;RepairSchedule&gt; result;
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      result = getPostgresStorage(h).getAllRepairSchedules();</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public boolean updateRepairSchedule(RepairSchedule newRepairSchedule) {
<b class="nc">&nbsp;    boolean result = false;</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      int rowsAdded = getPostgresStorage(h).updateRepairSchedule(newRepairSchedule);</b>
<b class="nc">&nbsp;      if (rowsAdded &lt; 1) {</b>
<b class="nc">&nbsp;        LOG.warn(&quot;failed updating repair schedule with id: {}&quot;, newRepairSchedule.getId());</b>
&nbsp;      } else {
<b class="nc">&nbsp;        result = true;</b>
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Optional&lt;RepairSchedule&gt; deleteRepairSchedule(UUID id) {
<b class="nc">&nbsp;    RepairSchedule result = null;</b>
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      IStoragePostgreSql pg = getPostgresStorage(h);</b>
<b class="nc">&nbsp;      RepairSchedule scheduleToDel = pg.getRepairSchedule(UuidUtil.toSequenceId(id));</b>
<b class="nc">&nbsp;      if (scheduleToDel != null) {</b>
<b class="nc">&nbsp;        int rowsDeleted = pg.deleteRepairSchedule(UuidUtil.toSequenceId(scheduleToDel.getId()));</b>
<b class="nc">&nbsp;        if (rowsDeleted &gt; 0) {</b>
<b class="nc">&nbsp;          result = scheduleToDel.with().state(RepairSchedule.State.DELETED).build(id);</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    if (result != null) {</b>
<b class="nc">&nbsp;      tryDeletingRepairUnit(result.getRepairUnitId());</b>
&nbsp;    }
<b class="nc">&nbsp;    return Optional.fromNullable(result);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairRunStatus&gt; getClusterRunStatuses(String clusterName, int limit) {
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      return getPostgresStorage(h).getClusterRunOverview(clusterName, limit);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Collection&lt;RepairScheduleStatus&gt; getClusterScheduleStatuses(String clusterName) {
<b class="nc">&nbsp;    try (Handle h = jdbi.open()) {</b>
<b class="nc">&nbsp;      return getPostgresStorage(h).getClusterScheduleOverview(clusterName);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-02 20:53</div>
</div>
</body>
</html>
