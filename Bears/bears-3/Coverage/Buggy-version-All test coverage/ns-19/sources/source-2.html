


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > NodesStatus</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">io.cassandrareaper.resources.view</a>
</div>

<h1>Coverage Summary for Class: NodesStatus (io.cassandrareaper.resources.view)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">NodesStatus</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/91)
  </span>
</td>
</tr>
  <tr>
    <td class="name">NodesStatus$EndpointState</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">NodesStatus$GossipInfo</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/134)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package io.cassandrareaper.resources.view;
&nbsp;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;import java.util.regex.Matcher;
&nbsp;import java.util.regex.Pattern;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import com.fasterxml.jackson.annotation.JsonProperty;
&nbsp;import com.google.common.base.Optional;
&nbsp;import com.google.common.collect.Sets;
&nbsp;import jersey.repackaged.com.google.common.collect.Lists;
&nbsp;import jersey.repackaged.com.google.common.collect.Maps;
&nbsp;
&nbsp;public final class NodesStatus {
&nbsp;
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_NAME_PATTERNS = Lists.newArrayList();</b>
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_STATUS_PATTERNS = Lists.newArrayList();</b>
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_DC_PATTERNS = Lists.newArrayList();</b>
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_RACK_PATTERNS = Lists.newArrayList();</b>
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_LOAD_PATTERNS = Lists.newArrayList();</b>
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_RELEASE_PATTERNS = Lists.newArrayList();</b>
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_SEVERITY_PATTERNS = Lists.newArrayList();</b>
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_HOSTID_PATTERNS = Lists.newArrayList();</b>
<b class="nc">&nbsp;  private static final List&lt;Pattern&gt; ENDPOINT_TOKENS_PATTERNS = Lists.newArrayList();</b>
&nbsp;
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_NAME_PATTERN</b>
<b class="nc">&nbsp;      = Pattern.compile(&quot;^([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})&quot;, Pattern.MULTILINE | Pattern.DOTALL);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_STATUS_22_PATTERN = Pattern.compile(&quot;(STATUS):([0-9]*):(\\w+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_DC_22_PATTERN = Pattern.compile(&quot;(DC):([0-9]*):([0-9a-zA-Z-\\.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_RACK_22_PATTERN = Pattern.compile(&quot;(RACK):([0-9]*):([0-9a-zA-Z-\\.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_LOAD_22_PATTERN = Pattern.compile(&quot;(LOAD):([0-9]*):([0-9eE.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_RELEASE_22_PATTERN = Pattern.compile(&quot;(RELEASE_VERSION):([0-9]*):([0-9.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_SEVERITY_22_PATTERN = Pattern.compile(&quot;(SEVERITY):([0-9]*):([0-9.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_HOSTID_22_PATTERN = Pattern.compile(&quot;(HOST_ID):([0-9]*):([0-9a-z-]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_TOKENS_22_PATTERN = Pattern.compile(&quot;(TOKENS):([0-9]*)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_STATUS_21_PATTERN = Pattern.compile(&quot;(STATUS)(:)(\\w+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_DC_21_PATTERN = Pattern.compile(&quot;(DC)(:)([0-9a-zA-Z-\\.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_RACK_21_PATTERN = Pattern.compile(&quot;(RACK)(:)([0-9a-zA-Z-\\.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_LOAD_21_PATTERN = Pattern.compile(&quot;(LOAD)(:)([0-9eE.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_RELEASE_21_PATTERN = Pattern.compile(&quot;(RELEASE_VERSION)(:)([0-9.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_SEVERITY_21_PATTERN = Pattern.compile(&quot;(SEVERITY)(:)([0-9.]+)&quot;);</b>
<b class="nc">&nbsp;  private static final Pattern ENDPOINT_HOSTID_21_PATTERN = Pattern.compile(&quot;(HOST_ID)(:)([0-9a-z-]+)&quot;);</b>
&nbsp;
&nbsp;  private static final String NOT_AVAILABLE = &quot;Not available&quot;;
&nbsp;
&nbsp;  @JsonProperty
&nbsp;  public final List&lt;GossipInfo&gt; endpointStates;
&nbsp;
&nbsp;  static {
<b class="nc">&nbsp;    initPatterns();</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  public NodesStatus(List&lt;GossipInfo&gt; endpointStates) {</b>
<b class="nc">&nbsp;    this.endpointStates = endpointStates;</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  public NodesStatus(String sourceNode, String allEndpointStates, Map&lt;String, String&gt; simpleStates) {</b>
<b class="nc">&nbsp;    this.endpointStates = Lists.newArrayList();</b>
<b class="nc">&nbsp;    this.endpointStates.add(parseEndpointStatesString(sourceNode, allEndpointStates, simpleStates));</b>
&nbsp;  }
&nbsp;
&nbsp;  private GossipInfo parseEndpointStatesString(
&nbsp;      String sourceNode,
&nbsp;      String allEndpointStates,
&nbsp;      Map&lt;String, String&gt; simpleStates) {
&nbsp;
<b class="nc">&nbsp;    List&lt;EndpointState&gt; endpointStates = Lists.newArrayList();</b>
<b class="nc">&nbsp;    Set&lt;String&gt; endpoints = Sets.newHashSet();</b>
&nbsp;    Matcher matcher;
&nbsp;
<b class="nc">&nbsp;    String[] strEndpoints = allEndpointStates.split(&quot;(?&lt;![0-9a-zA-Z ])/&quot;);</b>
<b class="nc">&nbsp;    Double totalLoad = 0.0;</b>
&nbsp;
<b class="nc">&nbsp;    for (int i = 1; i &lt; strEndpoints.length; i++) {</b>
<b class="nc">&nbsp;      String endpointString = strEndpoints[i];</b>
<b class="nc">&nbsp;      Optional&lt;String&gt; status = Optional.absent();</b>
<b class="nc">&nbsp;      Optional&lt;String&gt; endpoint = parseEndpointState(ENDPOINT_NAME_PATTERNS, endpointString, 1, String.class);</b>
&nbsp;
<b class="nc">&nbsp;      for (Pattern endpointStatusPattern : ENDPOINT_STATUS_PATTERNS) {</b>
<b class="nc">&nbsp;        matcher = endpointStatusPattern.matcher(endpointString);</b>
<b class="nc">&nbsp;        if (matcher.find() &amp;&amp; matcher.groupCount() &gt;= 3) {</b>
<b class="nc">&nbsp;          status = Optional.of(matcher.group(3) + &quot; - &quot; + simpleStates.getOrDefault(&quot;/&quot; + endpoint.or(&quot;&quot;), &quot;UNKNOWN&quot;));</b>
<b class="nc">&nbsp;          break;</b>
&nbsp;        }
&nbsp;      }
&nbsp;
<b class="nc">&nbsp;      Optional&lt;String&gt; dc = parseEndpointState(ENDPOINT_DC_PATTERNS, endpointString, 3, String.class);</b>
<b class="nc">&nbsp;      Optional&lt;String&gt; rack = parseEndpointState(ENDPOINT_RACK_PATTERNS, endpointString, 3, String.class);</b>
<b class="nc">&nbsp;      Optional&lt;Double&gt; severity = parseEndpointState(ENDPOINT_SEVERITY_PATTERNS, endpointString, 3, Double.class);</b>
<b class="nc">&nbsp;      Optional&lt;String&gt; releaseVersion = parseEndpointState(ENDPOINT_RELEASE_PATTERNS, endpointString, 3, String.class);</b>
<b class="nc">&nbsp;      Optional&lt;String&gt; hostId = parseEndpointState(ENDPOINT_HOSTID_PATTERNS, endpointString, 3, String.class);</b>
<b class="nc">&nbsp;      Optional&lt;String&gt; tokens = parseEndpointState(ENDPOINT_TOKENS_PATTERNS, endpointString, 2, String.class);</b>
<b class="nc">&nbsp;      Optional&lt;Double&gt; load = parseEndpointState(ENDPOINT_LOAD_PATTERNS, endpointString, 3, Double.class);</b>
<b class="nc">&nbsp;      totalLoad += load.or(0.0);</b>
&nbsp;
<b class="nc">&nbsp;      EndpointState endpointState = new EndpointState(</b>
<b class="nc">&nbsp;          endpoint.or(NOT_AVAILABLE),</b>
<b class="nc">&nbsp;          hostId.or(NOT_AVAILABLE),</b>
<b class="nc">&nbsp;          dc.or(NOT_AVAILABLE),</b>
<b class="nc">&nbsp;          rack.or(NOT_AVAILABLE),</b>
<b class="nc">&nbsp;          status.or(NOT_AVAILABLE),</b>
<b class="nc">&nbsp;          severity.or(0.0),</b>
<b class="nc">&nbsp;          releaseVersion.or(NOT_AVAILABLE),</b>
<b class="nc">&nbsp;          tokens.or(NOT_AVAILABLE),</b>
<b class="nc">&nbsp;          load.or(0.0));</b>
&nbsp;
<b class="nc">&nbsp;      endpoints.add(endpoint.or(NOT_AVAILABLE));</b>
<b class="nc">&nbsp;      endpointStates.add(endpointState);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Map&lt;String, Map&lt;String, List&lt;EndpointState&gt;&gt;&gt; endpointsByDcAndRack = Maps.newHashMap();</b>
<b class="nc">&nbsp;    Map&lt;String, List&lt;EndpointState&gt;&gt; endpointsByDc</b>
<b class="nc">&nbsp;        = endpointStates.stream().collect(Collectors.groupingBy(EndpointState::getDc, Collectors.toList()));</b>
&nbsp;
<b class="nc">&nbsp;    for (String dc : endpointsByDc.keySet()) {</b>
<b class="nc">&nbsp;      Map&lt;String, List&lt;EndpointState&gt;&gt; endpointsByRack</b>
<b class="nc">&nbsp;          = endpointsByDc.get(dc).stream().collect(Collectors.groupingBy(EndpointState::getRack, Collectors.toList()));</b>
<b class="nc">&nbsp;      endpointsByDcAndRack.put(dc, endpointsByRack);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    return new GossipInfo(sourceNode, endpointsByDcAndRack, totalLoad, endpoints);</b>
&nbsp;  }
&nbsp;
&nbsp;  private &lt;T&gt; Optional&lt;T&gt; parseEndpointState(List&lt;Pattern&gt; patterns, String endpointString, int group, Class&lt;T&gt; type) {
<b class="nc">&nbsp;    Optional&lt;T&gt; result = Optional.absent();</b>
<b class="nc">&nbsp;    for (Pattern pattern : patterns) {</b>
<b class="nc">&nbsp;      Matcher matcher = pattern.matcher(endpointString);</b>
<b class="nc">&nbsp;      if (matcher.find() &amp;&amp; matcher.groupCount() &gt;= group) {</b>
<b class="nc">&nbsp;        result = (Optional&lt;T&gt;) Optional.of(matcher.group(group));</b>
<b class="nc">&nbsp;        if (type.equals(Double.class)) {</b>
<b class="nc">&nbsp;          result = (Optional&lt;T&gt;) Optional.of(Double.parseDouble(matcher.group(group)));</b>
&nbsp;        }
<b class="nc">&nbsp;        break;</b>
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  private static void initPatterns() {
<b class="nc">&nbsp;    ENDPOINT_NAME_PATTERNS.add(ENDPOINT_NAME_PATTERN);</b>
<b class="nc">&nbsp;    ENDPOINT_STATUS_PATTERNS.addAll(Arrays.asList(ENDPOINT_STATUS_22_PATTERN, ENDPOINT_STATUS_21_PATTERN));</b>
<b class="nc">&nbsp;    ENDPOINT_DC_PATTERNS.addAll(Arrays.asList(ENDPOINT_DC_22_PATTERN, ENDPOINT_DC_21_PATTERN));</b>
<b class="nc">&nbsp;    ENDPOINT_RACK_PATTERNS.addAll(Arrays.asList(ENDPOINT_RACK_22_PATTERN, ENDPOINT_RACK_21_PATTERN));</b>
<b class="nc">&nbsp;    ENDPOINT_LOAD_PATTERNS.addAll(Arrays.asList(ENDPOINT_LOAD_22_PATTERN, ENDPOINT_LOAD_21_PATTERN));</b>
<b class="nc">&nbsp;    ENDPOINT_RELEASE_PATTERNS.addAll(Arrays.asList(ENDPOINT_RELEASE_22_PATTERN, ENDPOINT_RELEASE_21_PATTERN));</b>
<b class="nc">&nbsp;    ENDPOINT_SEVERITY_PATTERNS.addAll(Arrays.asList(ENDPOINT_SEVERITY_22_PATTERN, ENDPOINT_SEVERITY_21_PATTERN));</b>
<b class="nc">&nbsp;    ENDPOINT_HOSTID_PATTERNS.addAll(Arrays.asList(ENDPOINT_HOSTID_22_PATTERN, ENDPOINT_HOSTID_21_PATTERN));</b>
<b class="nc">&nbsp;    ENDPOINT_TOKENS_PATTERNS.add(ENDPOINT_TOKENS_22_PATTERN);</b>
&nbsp;  }
&nbsp;
&nbsp;  public static final class GossipInfo {
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final String sourceNode;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final Map&lt;String, Map&lt;String, List&lt;EndpointState&gt;&gt;&gt; endpoints;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final Double totalLoad;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final Set&lt;String&gt; endpointNames;
&nbsp;
<b class="nc">&nbsp;    public GossipInfo(</b>
&nbsp;        String sourceNode,
&nbsp;        Map&lt;String, Map&lt;String, List&lt;EndpointState&gt;&gt;&gt; endpoints,
&nbsp;        Double totalLoad,
&nbsp;        Set&lt;String&gt; endpointNames) {
&nbsp;
<b class="nc">&nbsp;      this.sourceNode = sourceNode;</b>
<b class="nc">&nbsp;      this.endpoints = endpoints;</b>
<b class="nc">&nbsp;      this.totalLoad = totalLoad;</b>
<b class="nc">&nbsp;      this.endpointNames = endpointNames;</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  public static final class EndpointState {
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final String endpoint;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final String hostId;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final String dc;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final String rack;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final String status;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final Double severity;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final String releaseVersion;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final String tokens;
&nbsp;
&nbsp;    @JsonProperty
&nbsp;    public final Double load;
&nbsp;
<b class="nc">&nbsp;    public EndpointState(</b>
&nbsp;        String endpoint,
&nbsp;        String hostId,
&nbsp;        String dc,
&nbsp;        String rack,
&nbsp;        String status,
&nbsp;        Double severity,
&nbsp;        String releaseVersion,
&nbsp;        String tokens,
&nbsp;        Double load) {
&nbsp;
<b class="nc">&nbsp;      this.endpoint = endpoint;</b>
<b class="nc">&nbsp;      this.hostId = hostId;</b>
<b class="nc">&nbsp;      this.dc = dc;</b>
<b class="nc">&nbsp;      this.rack = rack;</b>
<b class="nc">&nbsp;      this.status = status;</b>
<b class="nc">&nbsp;      this.severity = severity;</b>
<b class="nc">&nbsp;      this.releaseVersion = releaseVersion;</b>
<b class="nc">&nbsp;      this.tokens = tokens;</b>
<b class="nc">&nbsp;      this.load = load;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getDc() {
<b class="nc">&nbsp;      return this.dc;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getRack() {
<b class="nc">&nbsp;      return this.rack;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String toString() {
<b class="nc">&nbsp;      return &quot;Endpoint : &quot;</b>
<b class="nc">&nbsp;          + endpoint</b>
<b class="nc">&nbsp;          + &quot; / &quot;</b>
<b class="nc">&nbsp;          + &quot;Status : &quot;</b>
<b class="nc">&nbsp;          + status</b>
<b class="nc">&nbsp;          + &quot; / &quot;</b>
<b class="nc">&nbsp;          + &quot;DC : &quot;</b>
<b class="nc">&nbsp;          + dc</b>
<b class="nc">&nbsp;          + &quot; / &quot;</b>
<b class="nc">&nbsp;          + &quot;Rack : &quot;</b>
<b class="nc">&nbsp;          + rack</b>
<b class="nc">&nbsp;          + &quot; / &quot;</b>
<b class="nc">&nbsp;          + &quot;Release version : &quot;</b>
<b class="nc">&nbsp;          + releaseVersion</b>
<b class="nc">&nbsp;          + &quot; / &quot;</b>
<b class="nc">&nbsp;          + &quot;Load : &quot;</b>
<b class="nc">&nbsp;          + load</b>
<b class="nc">&nbsp;          + &quot; / &quot;</b>
<b class="nc">&nbsp;          + &quot;Severity : &quot;</b>
<b class="nc">&nbsp;          + severity</b>
<b class="nc">&nbsp;          + &quot; / &quot;</b>
<b class="nc">&nbsp;          + &quot;Host Id : &quot;</b>
<b class="nc">&nbsp;          + hostId</b>
<b class="nc">&nbsp;          + &quot; / &quot;</b>
<b class="nc">&nbsp;          + &quot;Tokens : &quot;</b>
<b class="nc">&nbsp;          + tokens;</b>
&nbsp;    }
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-09 22:17</div>
</div>
</body>
</html>
